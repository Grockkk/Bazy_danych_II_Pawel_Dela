
--1 Zaimportuj następujące pliki shapefile do bazy, przyjmij wszędzie układ WGS84:
--Znajdź budynki, które zostały wybudowane lub wyremontowane na przestrzeni roku (zmiana
--pomiędzy 2018 a 2019)

SELECT t2018_kar_buildings.polygon_id AS id, t2018_kar_buildings.geom AS geometry
FROM t2018_kar_buildings,t2019_kar_buildings 
WHERE ST_Equals(t2018_kar_buildings.geom,t2019_kar_buildings.geom) = False
GROUP BY t2018_kar_buildings.gid
ORDER BY id  

--2 Znajdź ile nowych POI pojawiło się w promieniu 500 m od wyremontowanych lub
--wybudowanych budynków, które znalezione zostały w zadaniu 1. Policz je wg ich kategorii.




--3 Utwórz nową tabelę o nazwie ‘streets_reprojected’, która zawierać będzie dane z tabeli
--T2019_KAR_STREETS przetransformowane do układu współrzędnych DHDN.Berlin/Cassini (3068).
CREATE TABLE  streets_reprojected AS(
SELECT gid,link_id,st_name,ref_in_id,nref_in_id,func_class,speed_cat,fr_speed_l,to_speed_l,dir_travel,ST_SetSRID(geom,3068) FROM T2019_KAR_STREETS
);
SELECT * FROM T2019_KAR_STREETS
--Pan mowił żeby uzyc ST_Transform ale to nie działa bo nie ma układu nadanego

DROP TABLE streets_reprojected;

--4 Stwórz tabelę o nazwie ‘input_points’ i dodaj do niej dwa rekordy o geometrii punktowej.
--Użyj następujących współrzędnych:
--X Y
--8.36093 49.03174
--8.39876 49.00644
--Przyjmij układ współrzędnych GPS(WGS84).

CREATE TABLE  input_points (
	id INT PRIMARY KEY,
	geom GEOMETRY,
	name VARCHAR (10)
);
INSERT INTO input_points VALUES
(1,ST_GeomFromText('POINT(8.36093 49.03174)',4326),'X'),
(2,ST_GeomFromText('POINT(8.39876 49.00644)',4326),'Y');
SELECT * FROM input_points;

DROP TABLE input_points

SELECT ST_AsText(input_points.geom) FROM input_points;
--5 Zaktualizuj dane w tabeli ‘input_points’ tak, aby punkty te były w układzie współrzędnych
--DHDN.Berlin/Cassini. Wyświetl współrzędne za pomocą funkcji ST_AsText().

UPDATE input_points
SET geom = ST_Transform(input_points.geom,3068)

SELECT ST_AsText(input_points.geom) AS geom_point FROM input_points

--6 Znajdź wszystkie skrzyżowania, które znajdują się w odległości 200 m od linii zbudowanej
--z punktów w tabeli ‘input_points’. Wykorzystaj tabelę T2019_STREET_NODE. Dokonaj
--reprojekcji geometrii, aby była zgodna z resztą tabel.

UPDATE input_points 
SET geom = ST_SetSRID(t2019_kar_street_node.geom,3068) FROM t2019_kar_street_node

SELECT lat,lon,t2019_kar_street_node.geom FROM t2019_kar_street_node , input_points
WHERE ST_Contains(t2019_kar_street_node.geom,ST_Buffer(ST_MakeLine((SELECT geom FROM input_points WHERE name = 'X'),(SELECT geom FROM input_points WHERE name = 'Y')),200))

--7 Policz jak wiele sklepów sportowych (‘Sporting Goods Store’ - tabela POIs) znajduje się
--w odległości 300 m od parków (LAND_USE_A).
SELECT COUNT(t2019_kar_poi_table.type) AS sum FROM t2019_kar_poi_table,t2019_kar_land_use_a
	WHERE t2019_kar_poi_table.type = 'Sporting Goods Store' AND t2019_kar_land_use_a.type = 'Park (City/County)'
	AND ST_Contains(ST_Buffer(t2019_kar_land_use_a.geom,300),t2019_kar_poi_table.geom)



-- 8 Znajdź punkty przecięcia torów kolejowych (RAILWAYS) z ciekami (WATER_LINES). Zapisz
--znalezioną geometrię do osobnej tabeli o nazwie ‘T2019_KAR_BRIDGES’


CREATE TABLE T2019_KAR_BRIDGES AS(
SELECT ST_Intersection(t2019_kar_water_lines.geom , t2019_kar_railways.geom) FROM t2019_kar_water_lines, t2019_kar_railways
);

SELECT * FROM T2019_KAR_BRIDGES

DROP TABLE T2019_KAR_BRIDGES





















SELECT * FROM t2019_kar_water_lines

SELECT * FROM t2019_kar_buildings ORDER BY polygon_id
-- 4326
SELECT * FROM t2018_kar_poi_table
SELECT * FROM t2019_kar_poi_table



---------------------------------------------------------------------------------

